# by Will Freyman
#
# source("/Users/mucho/Documents/projects/revbayes/tutorials/RB_Chromosomes/chromosome_test_likelihood_repeated_squaring.Rev")
#

# read the data 
# real data from mayrose 2010
# this is hack data because Aristolochia_taliscana and Aristolochia_tentaculata are sisters on 0 length branches,
# yet are supposed to have chromosome numbers of 6 and 7 respectively. This causes a bug in MonteCarloSampler.cpp "Could not compute lnProb for node seq"
# therefore both species are set to chromosome number 7. This bug could probably be fixed by setting all 0 branch lengths to 0.000001 or something...
chromoData <- readChromosomes("/Users/mucho/Documents/projects/revbayes/tutorials/RB_Chromosomes/data/matK_chromosomes_hack.tsv")

# work under fixed topology with total tree length = 0.2907
# Mayrose et al 2010 found about 1 polyploidization event and ~1.5 chromosome increases and ~8 decreases
# so we expect roughly lambda = 5.2, delta = 27, and rho = 3.48 (though Mayrose et al had different branch lengths) 
treeArray <- readTrees("/Users/mucho/Documents/projects/revbayes/tutorials/RB_Chromosomes/data/matK_tree_lengths.nwk")
psi <- treeArray[1]


#######################
# Chromosome Model
#######################


# rate of chromosome gains
lambda <- 1.0

# rate of chromosome losses
delta <- 1.0

# rate of polyploidization
rho <- 1.0

# max number of chromosomes
max_chromo <- 35

# create rate matrix
Q := chromosomes(max_chromo, lambda, delta, rho)

#########
## TODO: properly estimate root state!!!
#########

## need to create a chromosomeRF (see pomoRF) function that takes the root state (uniform 1 to max_chromo) parameter
## and returns a simplex:
## here we set the root state to 8 found to be most likely in Mayrose et al 2010
root_frequencies := simplex(0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)

##############
# set up moves
#############
moves[1] <- mvScale(lambda)

###############
# create the model
###############
seq ~ phyloCTMC(Q=Q, tree=psi, rootFreq=root_frequencies,type="Chromosomes")

# clamp data
seq.clamp(chromoData)

mymodel <- model(Q)

# create the monitors
monitors[1] <- screenmonitor(printgen=10, lambda, delta, rho)
monitors[2] <- modelmonitor(filename="/Users/mucho/Documents/projects/revbayes/tutorials/RB_Chromosomes/output/chromosome_test_likelihood_repeated_squaring.log",printgen=10, separator = "	")
 
# set up mcmc
mymcmc <- mcmc(mymodel, monitors, moves)
mymcmc.run(100)

